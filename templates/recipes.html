<head>
  <title>Co-App Recipes</title>

  <link rel=”stylesheet” href=”https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css”/>

  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>

{% extends "templates/base.html" %}
{% block content %}

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-1"></div>

    <div class="col-sm-11">
      <!-- Title -->
      <div class="row text-left">
        <div class="text-left">
          <br>
          <h2>Recipes</h2><br>
        </div>
      </div>

      <!-- Toggle Buttons (Meal Type) -->
      <div class="row text-left">
          <div class="btn-group">
            <div class="col-sm-2">
              <label class="btn btn-secondary active" id="breakfast-toggle">
                <input type="radio" class="btn-check" name="break-option" id="breakfast-btn" autocomplete="off"> Breakfast
              </label>
            </div>
            <div class="col-sm-2">
              <label class="btn btn-secondary" id="lunch-toggle">
                <input type="radio" class="btn-check" name="lunch-option" id="lunch-btn" autocomplete="off"> Lunch
              </label>
            </div>
            <div class="col-sm-2">
              <label class="btn btn-secondary" id="din-toggle">
                <input type="radio" class="btn-check" name="din-option" id="din-btn" autocomplete="off"> Dinner
              </label>
            </div>
            <div class="col-sm-2">
              <label class="btn btn-secondary" id="dessert-toggle">
                <input type="radio" class="btn-check" name="dessert-option" id="dessert-btn" autocomplete="off"> Dessert
              </label>
            </div>
            <div class="col-sm-2">
              <label class="btn btn-secondary" id="other-toggle">
                <input type="radio" class="btn-check" name="other-option" id="other-btn" autocomplete="off"> Other
              </label>
            </div>
          </div>
      </div>

      <br>      

      <!-- Recipe Gallery Carousel -->
      <div class="row">
        <div iclass="col-sm-11 text-center">
          <!-- Carousel wrapper -->
          <div id="recipeCarousel" class="carousel slide carousel-dark text-center" data-bs-ride="carousel">
            <!-- SERVER-SIDE GENERATES RECIPE GALLERY HERE -->
          </div>
          <!-- Carousel wrapper -->
        </div>
      </div>

      <!-- Add Recipe Button (triggers modal) -->
      <div class="row">
        <div class="col-sm-11">
          <button type="button" class="btn btn-primary float-end" id="add-rec-btn" data-bs-toggle="modal"
            data-bs-target="#createRecipeModal">
            Add Recipe
          </button>
        </div>
      </div>

    </div> <!-- col-sm-11 -->
  </div> <!-- row -->
</div> <!-- container-fluid -->

<!-- Modal -->
<!-- #createRecipeModal -->
<div class="modal fade" id="createRecipeModal" tabindex="-1" role="dialog" aria-labelledby="recModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- header and close button -->
      <div class="modal-header">
        <h4>Add Your Recipe!</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- RECIPE FORM -->
      <div class="modal-body">

        <div class="form-group">
          <label for="recipe_name">Name of recipe:</label>
          <input type="text" class="form-control" id="recipe_name" autocapitalize="words" required>
        </div>
        <br>
        <div class="form-group">
          <label for="recipe_type">Recipe Type:</label>
          <select class="form-select" id="food_type" aria-label="Select food type">
            <option value="0" selected>Choose...</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch">Lunch</option>
            <option value="Dinner">Dinner</option>
            <option value="Dessert">Dessert</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <br>
        <div class="form-group">
          <label for="recipe_link">Link:</label>
          <input type="text" class="form-control" id="recipe_link">
        </div>
        <br>
        <div class="form-group">
          <label for="quantity">Ingredients:</label>
          <input type="text" class="form-control" id="recipe_ingredients">
        </div>
        <br>
        <div class="form-group">
          <label for="recipe_instructions">Instructions:</label>
          <input type="text" class="form-control" id="recipe_instructions" autocapitalize="sentences">
        </div>
        <br>
        <div>
          <div class="mb-4 d-flex justify-content-center">
            <img src="https://res.cloudinary.com/coapp/image/upload/v1669151022/prjhmx1wqmkxxzoypekd.png"
              id="recipe_img" alt="placeholder" style="width: 300px;" />
              <button id="upload_widget" class="cloudinary-button">Upload Image</button>
          </div>
        </div>
      </div>

      <!-- submit button -->
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="rec_submit">Submit Recipe</button>
      </div>
    </div>
  </div>
</div>

<script>
  'use strict';

  function handleResponse(response) {
    console.log(response);
    $('#recipeCarousel').html(response);
  }

  let request = null;

  function refreshGallery() {
    request = $.ajax(
      {
        type: 'GET',
        url: '/{{coop}}/recipes/gallery',
        success: handleResponse,
        failure: function () {
          alert('There was an error while fetching recipes!');
        }
      }
    );
  }

  function addRecipe() {
    $('#rec_submit').unbind('click');
    $('#add-rec-btn').unbind('click');

    // extract input from modal
    let recipe_name = $('#recipe_name').val();
    let recipe_link = $('#recipe_link').val();
    let recipe_ingredients = $('#recipe_ingredients').val();
    let recipe_instructions = $('#recipe_instructions').val();
    let recipe_img = $('#recipe_img').attr('src');

    // AJAX update database
    var json_event = {
      "recipe_author": "{{user.user_netid}}",
      "recipe_name": recipe_name,
      "recipe_link": recipe_link,
      "recipe_ingredients": recipe_ingredients,
      "recipe_instructions": recipe_instructions,
      "recipe_img": recipe_img
    };

    console.log(json_event)

    // AJAX POST request
    $.post("/{{coop}}/recipes", {
      dataType: 'json',
      contentType: 'application/json',
      event_data: JSON.stringify(json_event),
      // success: refresh gallery
    }).done(function (data) {
      console.log("success")
      refreshGallery();
    }).fail(function (jqXHR, textStatus, errorThrown) {
      alert("Error adding recipe. Try again!")
    });

    // hide modal
    $('#createRecipeModal').modal('hide');

    // reset all fields in modal
    $('#recipe_name').val('');
    $('#recipe_link').val('');
    $('#recipe_ingredients').val('');
    $('#recipe_instructions').val('');
    $('#recipe_img').attr('src', 'https://res.cloudinary.com/coapp/image/upload/v1669151022/prjhmx1wqmkxxzoypekd.png');

  }

  // replace placeholder image with uploaded img
  function readURL(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();

      reader.onload = function (e) {
        $('#placeholder_img').attr('src', e.target.result);
      }

      reader.readAsDataURL(input.files[0]);
    }
  }

  // handle event when Remove button clicked
  function removeRecipe(i) {
    let recipe_id = i.parentNode.lastChild.innerHTML;

    let url = "/{{coop}}/recipes/delete?id=" + recipe_id;

    if (confirm("Are you sure you want to remove this recipe?") == true) {
      request = $.ajax(
        {
          type: 'POST',
          url: url,
        }
      ).done(function (data) {
        refreshGallery();
      }).fail(function (jqXHR, textStatus, errorThrown) {
        alert("Error updating recipe gallery. Try again!")
      });
      // refresh list from deleting from db
    }
  }

  function setup() {
    // set up image uploading w/ cloudinary
    const myWidget = cloudinary.createUploadWidget(
      {
        cloudName: 'coapp',
        uploadPreset: 'dyew2nw8',
        multiple: false,  //restrict upload to a single file
        tags: ["{{coop}}"], //add the given tags to the uploaded files
        maxImageFileSize: 2000000,  //restrict file size to less than 2MB
        maxImageWidth: 1080, //Scales the image down to a width of 1080 pixels before uploading
        maxImageHeight: 1080,
        cropping: true,
        croppingValidateDimensions: true
      },
      (error, result) => {
        if (!error && result && result.event === "success") {
          document
            .getElementById("recipe_img")
            .setAttribute("src", result.info.secure_url);
        }
      }
    );
    document.getElementById("upload_widget").addEventListener(
      "click",
      function () {
        myWidget.open();
      },
      false
    );

    refreshGallery();

    $("#createRecipeModal").on("click", "#rec_submit", addRecipe);
    $(".btn-check").on("click", function() {
      console.log("detected button click")
    })
  }

  $('document').ready(setup);

</script>

{% endblock %}