<head>
  <title>Co-App Shopping List</title>
  <script type='text/javascript' src="{{ url_for('static',filename='jquery-3.6.1.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
</head>

{% extends "templates/base.html" %}
{% block content %}
<div class="row">
  <div class="col-sm-8">
    <br>
    <h2>Shopping Requests</h2><br>
  </div>
</div>

<div class="btn-group btn-group-toggle" data-toggle="buttons">
  <label class="btn btn-secondary active">
    <input type="radio" name="options" id="food-btn" autocomplete="off" checked> Food
  </label>
  <label class="btn btn-secondary">
    <input type="radio" name="options" id="equip-btn" autocomplete="off"> Equipment
  </label>
</div>

<div class="container-fluid">
  <div class="col-sm-11">
    <div class="container border border-dark rounded" style="background-color: #07a29930;">
      <div class="table-responsive" id="shoppingList">
        <!-- <table class="table" id="myTable" style="margin: 0;">
            <thead id="theader">
                <tr>
                    <th scope="col">Item</th>
                    <th scope="col">Type</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Comments</th>
                    <th scope="col">Alt Item</th>
                    <th scope="col">For Shift?</th>
                    <th scope="col">Ordered?</th>
                    <th scope="col"> </th>
                  </tr>
            </thead>
            <tbody id="tbody">
              <div id="shoppingList">

              </div> -->
                  <!-- {% for item in items: %}
                    <tr>
                        <th scope="row">{{item.item_name}}</th>
                        <td>{{item.item_type}}</td>
                        <td>{{item.item_quantity}}</td>
                        <td>{{item.item_reason}}</td>
                        <td>{{item.alt_request}}</td>
                        {% set shift = 'No' %}
                        {% if item.for_shift is sameas true %}
                          <td>Yes</td>
                        {% else %}
                          <td>No</td>
                        {% endif %}
                        <td>{{item.for_shift}}</td>
                        <td>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="order-check">
                            <label class="form-check-label" for="order-check">
                              {{item.item_ordered}}
                            </label>
                          </div>
                        </td>
                        <td>
                          <button type="button" class="btn btn-secondary btn-sm" id="rm-btn">Remove</button>
                        </td>
                    </tr>
                  {% endfor %} -->
            <!-- </tbody>
          </table>  -->
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
      <div class="col-md-12 text-right">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createItemModal">
          Add Item
        </button>
      </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="createItemModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- header and close button -->
      <div class="modal-header">
        <h4>Make Your Request!</h4>  
        </p><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span> <span
            class="sr-only">close</span></button>
      </div>

      <!-- SHOPPING LIST FORM -->
      <div class="modal-body"> 

        <div class="form-group">
            <label for="item_type">Item Type:</label><br>
            <select class="form-select" id="item_type" aria-label="Select item type">
                <option selected>Choose...</option>
                <option value="Food">Food</option>
                <option value="Equipment">Equipment</option>
            </select>
        </div>
        
        <!-- Only if food, show food type option -->
        <div class="form-group" id="food_type_visible" style="display: none">
            <label for="foodtype">Food Type:</label>
            <input type="text" class="form-control" id="food_type">
        </div>

        <div class="form-group">
            <label for="item">Requested Item:</label>
            <input type="text" class="form-control" id="item_name">
        </div>
        <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="text" class="form-control" id="item_quantity">
        </div>
        <div class="form-group">
            <label for="comments">Reason</label>
            <input type="text" class="form-control" id="item_reason">
        </div>
        <div class="form-group">
            <label for="alt_item">Alternate Request</label>
            <input type="text" class="form-control" id="alt_request">
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="for_shift" name="for_shift">
            <label class="form-check-label" for="for_shift">For Shift?</label>
        </div>

      </div>

      <!-- submit button -->
      <div class="modal-footer">
        <button type="submit" class="btn btn-secondary" id="add_submit">Submit Request</button>
      </div>
    </div>
  </div>
</div>

<script>
  'use strict';

  function handleResponse(response) 
  {
    $('#shoppingList').html(response);
  }

  let request = null;

  // refresh page with another get request 
  function refreshList() {
    console.log("fetching refreshed list");
    request = $.ajax(
        {
            type:'GET',
            url: '/{{coop}}/items',
            success: handleResponse,
            failure: function () {
              alert('there was an error while fetching items!');
            }
        }
    );
    console.log("made request")
  }

  // show food type option if applicable in modal
  $('#item_type').on('change', function () {
        console.log($('#item_type').val());
        if ($('#item_type').val() == "Food") {
          $('#food_type_visible').show();
        } else {
          $('#food_type_visible').hide();
        }
      });
  
  // add item to shopping list if submitted 
  function addItem() 
  {
    $('#add_submit').unbind('click');

    console.log("hello");

    // extract input from modal
    let item_type = $('#item_type').val();
    let food_type = ""
    if ($('#food_type') != null) {
      food_type = $('#food_type').val();
    }
    let item_name = $('#item_name').val();
    let item_quantity = $('#item_quantity').val();
    let item_reason = $('#item_reason').val();
    let alt_request = $('#alt_request').val();
    if ($('#for_shift').is(':checked')) {
      var for_shift = true;
    }
    else {
      for_shift = false;
    }

    // AJAX update database
    var json_event = {
      "item_type":item_type,
      "item_name":item_name,
      "item_quantity":item_quantity,
      "item_ordered":false,
      "for_shift": for_shift,
      "item_reason": item_reason,
      "requesting_user": "dpw@cs.princeton.edu",
      "food_type": food_type,
      "alt_request": alt_request
    };

    console.log(json_event)

    // AJAX post request
    $.post( "/{{coop}}/list", {
      dataType: 'json',
      contentType: 'application/json',
      event_data: JSON.stringify(json_event),
      success: refreshList
    });

    refreshList()

    // hide modal
    $('#createItemModal').modal('hide');

    // reset all fields in modal
    // ITEM TYPE -> FOOD
    $('#food_type').val('');
    $('#item_name').val('');
    $('#item_quantity').val('');
    $('#item_reason').val('');
    $('#alt_request').val('');
    // FOR SHIFT CHECKBOX

    
  }

  // handle event when remove button clicked
  function removeItem() {
    console.log('clicked')
    console.log(info)

    // EDIT ajax post request -- need anything other than id?
    url = "/{{coop}}/list/delete?id=" + info.event.id;

    request = $.ajax(
      {
        type: 'POST',
        url: url, 
        success: handleResponse,
        failure: function () {
          alert('there was an error while fetching items!');
        }
      }
    );

    // refresh list from deleting from db
  }

  // TODO: when ordered checkbox clicked, update in database, change words to "true"


  function setup() 
  {
    refreshList();
    // event handling
    $("#createItemModal").on( "click", "#add_submit", addItem);
    $('#rm-btn').on('click', removeItem);
    //  $("#myTable").on("click", console.log("TEST"))
  }

  $('document').ready(setup);

</script>

{% endblock %}